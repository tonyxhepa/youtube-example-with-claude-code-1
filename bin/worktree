#!/usr/bin/env bash
set -euo pipefail

# ---------------------------------------------------------------------------
# Usage: ./bin/worktree <name>
#
# Creates a new Git worktree at ../<project>--<name> on a new branch <name>,
# then bootstraps the Laravel app inside it.
# ---------------------------------------------------------------------------

if [[ $# -lt 1 ]]; then
    echo "Usage: $(basename "$0") <name>" >&2
    exit 1
fi

NAME="$1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"
WORKTREE_DIR="$(cd "$PROJECT_DIR/.." && pwd)/${PROJECT_NAME}--${NAME}"

if [[ -d "$WORKTREE_DIR" ]]; then
    echo "Error: worktree directory already exists: $WORKTREE_DIR" >&2
    exit 1
fi

echo "Creating worktree at: $WORKTREE_DIR"
git -C "$PROJECT_DIR" worktree add -b "$NAME" "$WORKTREE_DIR"

echo ""
echo "Installing dependencies..."
cd "$WORKTREE_DIR"

composer install
npm install
composer run post-root-package-install
composer run post-create-project-cmd
npm run build

echo ""
echo "Done. Worktree ready at: $WORKTREE_DIR"
